# What is Sergeant?
* Sergeant keep the schema synchronized in all database
* Return with status code which show whether or not the schema is identical to the schema in repository
* Sergeant is able to show the list of different objects
* Provide help in release process to make sure the schema has been released as it is in repository
* Generating schema version which is a snapshot of the actual state of the database
* Created schema version can be connected to specific git commit by providing sha1
* Ability to ignore objects from comparison by specifying the pattern or exact search like 'GetSearchProcedure' or 'deleted_'
* Ability to ignore object type from comparison such as 'FN' or 'P' and so on 

## Object types
Sergeant validate any differences on the following object types
* FN (function)
* FTI (full text index)
* IDX 	(index)
* IF	(inline function)
* P	(procedure)
* T	(table)
* TF	(table function)
* TVP	(table valued parameter)
* VW	(view)
* EP	(extended property)
* PRM	(permission)
* FG	(file group) 

## Parameters/Options
* version (string): Required parameter in the following form: '11.0', See the already created versions in the table Sergeant.SchemaVersion
* ShowObjects (boolean): Option to see the name of the objects found by Sergeant as object mismatch or content mismatch
* ignoreObject (table): Option to ignore specific object or object name pattern from the comparison
* ignoreType (table): Option to ignore specific object types from the comparison. Accepted object types above in the list

# Usage

```
EXEC Sergeant.HashMatch [ [@version = ] { value }, [@showObjects =]  { 1 | 0 }]
```
 
# Example
```
DECLARE @ret INT
EXEC @ret = Sergeant.HashMatch @version = '10.2', @showObjects = 1
SELECT @ret
```

Ignore objects from comparison
```
DECLARE @ret INT 
DECLARE @ignoreObject dbo.VC128
INSERT INTO @ignoreObject VALUES ('deleted_'),('tmp_'), ('Reporting_GetScheduledQueryResults')
EXEC @ret = Sergeant.HashMatch @ignoreObject = @ignoreObject
SELECT @ret
```

Ignore object types from comparision
```
DECLARE @ret INT
DECLARE @ignoreType dbo.VC128
INSERT INTO @ignoreType VALUES ('P'),('PRM')
EXEC @ret = Sergeant.HashMatch @ignoreType = @ignoreType
SELECT @ret
```


# Schema Version
Before every release new schema version have to be generated by calling the following procedure

``` 
EXEC Sergeant.CreateDataVersion @version = {@version}, @sha1 = {@sha1}
```

Parameter description:
* @version: schema version short name, or number. (e.g major version number 10.2)
* @sha1: Created schema version should be connected to git commit through sha1. To get the sha1 type: git rev-parse develop
 
Generated Schema version will be traveling with the release so it can be use as benchmark in comparison.
 
Schema versions historically stored in table:

``` 
SELECT * FROM Sergeant.SchemaVersion AS dv
```
 
# Schema format
 

```
<objects>
  <object name="function1">
    <Type>FN </Type>
    <MD5>2ErNoE+4/sKD9wpDKKgGzw==</MD5>
  </object>
  <object name="fti1">
    <Type>FTI</Type>
    <MD5>60C/sicCPQMjK3fHcpoQaw==</MD5>
  </object>
  <object name="table.index1">
    <Type>IDX</Type>
    <MD5>yQy8K05nezuSSOFlbfzW2w==</MD5>
  </object>
  ...
</objects>
``` 

# Return codes
Range is [2-99]

*0	OK
*-1:	Invalid parameter
*51:	Internal error
*88:	Data version already created (bold version or git sha1)
*2:	Object mismatch
*3:	Content mismatch
